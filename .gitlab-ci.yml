stages:
  - build
  - deploy

build_backend:
  stage: build
  image: maven:3.8.6-openjdk-18
  script:
    - cd Backend/
    - echo "Building app..."
    - mvn clean
    - mvn clean install
    - echo "Finished building the app."
  artifacts:
    paths:
      - Backend/target/pi-project-0.0.1-SNAPSHOT.jar

deploy_Backend:
  stage: deploy
  image: python:3.8
  before_script:
    - apt-get update && apt-get install -y awscli
    - eval $(ssh-agent -s)  # Start the SSH agent
  variables:
    AWS_DEFAULT_REGION: us-east-2
  script:
    - mkdir -p ok_hosts/.ssh
    - echo "$EC2_PEM_PRIVATE_KEY" > ok_hosts/.ssh/id_rsa
    - chmod 600 ok_hosts/.ssh/id_rsa
    - ssh-add ok_hosts/.ssh/id_rsa  # Add the private key to SSH agent
    - ssh-keyscan -H $EC2_PUBLIC_IP >> ok_hosts/.ssh/known_hosts
    - echo "Host key added to known_hosts."
    - ssh ubuntu@$DEPLOY_SERVER_IP "sudo systemctl stop back.service"
    - scp Backend/target/pi-project-0.0.1-SNAPSHOT.jar ubuntu@$DEPLOY_SERVER_IP:~/home/ubuntu/backend
    - ssh ubuntu@$DEPLOY_SERVER_IP "sudo systemctl start back.service"
    - echo "Finished deploying the app."
